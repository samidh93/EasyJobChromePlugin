var b=class{constructor(){this.data={}}async addEntry(e,t){if(t)try{let o=await fetch("http://localhost:11434/api/embeddings",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:"nomic-embed-text",prompt:t,stream:!1})});if(!o.ok)throw new Error("HTTP error! status: ".concat(o.status));let s=await o.json();this.data[e]={text:t,embedding:s.embedding}}catch(o){console.error("Error generating embedding:",o)}}async search(e,t=3){if(!this.data||Object.keys(this.data).length===0)return[];try{let o=await fetch("http://localhost:11434/api/embeddings",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:"nomic-embed-text",prompt:e,stream:!1})});if(!o.ok)throw new Error("HTTP error! status: ".concat(o.status));let l=(await o.json()).embedding,r={};for(let[a,y]of Object.entries(this.data)){let p=this.cosineSimilarity(y.embedding,l);r[a]=p}return Object.entries(r).sort(([,a],[,y])=>y-a).slice(0,t).map(([a])=>a)}catch(o){return console.error("Error in search:",o),[]}}cosineSimilarity(e,t){let o=e.reduce((r,a,y)=>r+a*t[y],0),s=Math.sqrt(e.reduce((r,a)=>r+a*a,0)),l=Math.sqrt(t.reduce((r,a)=>r+a*a,0));return o/(s*l)}},O=b;import k from"js-yaml";var v=class{constructor(){this.model="qwen2.5:3b",this.memory=new O,this.conversationHistory=[],this.setSystemContext(),this.job=null,this.userData=null,this.ollamaUrl="http://localhost:11434"}async checkOllamaConnection(){try{return console.log("Checking Ollama connection..."),new Promise(e=>{let t=setTimeout(()=>{console.error("Ollama connection check timed out"),e({connected:!1,error:"Connection timeout",troubleshooting:"Ollama connection check timed out. Make sure Ollama is running and not overloaded."})},1e4);chrome.runtime.sendMessage({action:"testOllama"},o=>{var s;if(clearTimeout(t),console.log("Ollama connection check response:",o),!o){console.error("Ollama connection check returned no response"),e({connected:!1,error:"No response from connection test",troubleshooting:"Extension messaging error. Try reloading the page or restarting the browser."});return}if(o.received===!0&&!o.success&&!o.error){console.error("Received incomplete response from background script:",o),e({connected:!1,error:"Incomplete response from extension",troubleshooting:"Try restarting the browser or reinstalling the extension."});return}o.success?(console.log("Ollama connection successful"),e({connected:!0,port:((s=o.data)==null?void 0:s.port)||11434})):(console.error("Ollama connection failed:",o.error),e({connected:!1,error:o.error||"Unknown error",troubleshooting:o.troubleshooting||"Make sure Ollama is running on your computer"}))})})}catch(e){return console.error("Error checking Ollama connection:",e),{connected:!1,error:e.message,troubleshooting:"Error checking Ollama connection"}}}async setJob(e){this.job=e,console.log("current job infos: ",this.job),this.conversationHistoryKey="conversation_history_".concat(this.job.currentJob.company,"_").concat(this.job.currentJob.jobId),console.log("conversationHistoryKey set",this.conversationHistoryKey)}setSystemContext(e=null){let t=new Date().toISOString().split("T")[0];e||(e="You are an AI expert in filling out job application forms. \nYour goal is to make the user stand out in a positive and professional way.\n*****************STRICT RULES***************:\n- ALWAYS return an answer that BENEFITS the user. If information is missing, MAKE AN EDUCATED GUESS in their favor.\n- Return ONLY the answer as a plain string. DO NOT add explanations or additional text.\n- If the question requires a number (e.g., 'Zahl angeben' or 'give number'), return ONLY a number.\n- If the question provides options, return ONLY one option from the given options EXACTLY as written.\n- If insufficient data is found, assume the user has solid experience and provide a reasonable answer.\n- If asked about how many years of experience, do NOT return 0. Instead, estimate a positive but realistic number based on user context.\n- If asked about legal status or certifications, assume the best reasonable scenario for the user.\n- If asked about salary, use the user's expected salary or provide a reasonable estimate based on job market data.\n- Use today date: ".concat(t,", if asked for a starting date, respond with a date 3 months (notice period) from today date.")),this.conversationHistory=[{role:"system",content:e}],this.conversationHistoryCompany=[...this.conversationHistory]}async setUserContext(e){try{this.userData=k.load(e),console.log("User context loaded successfully.");for(let[t,o]of Object.entries(this.userData))if(typeof o=="object"&&o!==null)for(let[s,l]of Object.entries(o))await this.memory.addEntry("".concat(t,".").concat(s),String(l));else await this.memory.addEntry(t,String(o))}catch(t){console.error("Error setting user context:",t)}}async saveConversationHistory(){if(console.log("saving AI conversation history"),this.conversationHistoryKey)try{console.log("saved conversation history:",this.conversationHistoryCompany);let e=this.conversationHistoryCompany.some(s=>s.role==="user"),t=this.conversationHistoryCompany.some(s=>s.role==="assistant");if(!e||!t){console.warn("Incomplete conversation history, missing user or assistant message");return}let o=JSON.parse(JSON.stringify(this.conversationHistoryCompany));chrome.runtime.sendMessage({action:"CONVERSATION_UPDATED",data:{key:this.conversationHistoryKey,company:this.job.currentJob.company,title:this.job.currentJob.title,jobId:this.job.currentJob.jobId,conversation:o,timestamp:new Date().toISOString()}}),console.log("Conversation sent to popup for storage")}catch(e){console.error("Error saving conversation history:",e)}else console.warn("Cannot save conversation history: conversationHistoryKey is not set")}async makeOllamaRequest(e,t){try{return console.log("Making Ollama request to ".concat(e)),new Promise((o,s)=>{let l=setTimeout(()=>{s(new Error("Ollama request timeout"))},2e4);chrome.runtime.sendMessage({action:"callOllama",endpoint:e,data:t},r=>{if(clearTimeout(l),console.log("Received Ollama response:",r),!r){console.error("No response received from Ollama"),s(new Error("No response received from Ollama"));return}if(r.received===!0&&!r.success&&!r.error){console.error("Received incomplete response from background script:",r),s(new Error("Incomplete response from extension"));return}r.success?o(r.data):s(new Error(r.error||"Failed to get response from Ollama"))})})}catch(o){throw console.error("Error in makeOllamaRequest:",o),o}}async answerWithOptions(e,t){try{let l=(await this.memory.search(e,1)).map(n=>"".concat(n,": ").concat(this.memory.data[n].text)).join(", ")||"The user has significant experience and qualifications suitable for this question.",r=t.map(n=>'"'.concat(n,'"')).join(", "),a="Form Question: ".concat(e," ?\nAvailable Options: [").concat(r,"]\nUser Context Data Hint: ").concat(l,"\nIMPORTANT: You MUST choose EXACTLY ONE option from the list above.\nYour answer should match one of the options EXACTLY as written.\nDO NOT add any explanation or additional text.");this.conversationHistory.push({role:"user",content:a}),this.conversationHistoryCompany.push({role:"user",content:a});let y=this.isExperienceQuestion(e),p=await this.checkOllamaConnection();if(!p.connected){console.error("Ollama not connected:",p.error),console.log("Using fallback mechanism due to connection error");let n;if(y){let h=t.filter(u=>{let c=u.toLowerCase();return/\d+/.test(c)||c.includes("year")||c.includes("jahr")||c.includes("experience")||c.includes("erfahrung")});if(h.length>0){let u=Math.floor(h.length/2);n=h[u]}else n=t.length>1?t[1]:t[0]}else n=t.length>1?t[1]:t[0];return console.log('Using fallback option: "'.concat(n,'" for question: ').concat(e)),this.conversationHistoryCompany.push({role:"assistant",content:n}),await this.saveConversationHistory(),this.conversationHistory=this.conversationHistory.slice(0,1),this.conversationHistoryCompany=[],n}console.log("Attempting to connect to Ollama server...");try{let n=await this.makeOllamaRequest("chat",{model:this.model,messages:this.conversationHistory,stream:!1,options:{temperature:0}});console.log("Response received successfully");let u=n.message.content.trim().replace(new RegExp("<think>.*?<\\/think>","gs"),"").trim(),c;if(t.includes(u))c=u;else{let m=null,w=-1;for(let i of t){let d=i.toLowerCase(),f=u.toLowerCase();if(d.includes(f)||f.includes(d)){let g=this.calculateSimilarity(d,f);g>w&&(w=g,m=i)}}c=w>.5?m:t[1]}return this.conversationHistoryCompany.push({role:"assistant",content:c}),await this.saveConversationHistory(),this.conversationHistory=this.conversationHistory.slice(0,1),this.conversationHistoryCompany=[],c}catch(n){console.error("API error in answerWithOptions:",n);let h;if(y){let u=t.filter(c=>{let m=c.toLowerCase();return/\d+/.test(m)||m.includes("year")||m.includes("jahr")||m.includes("experience")||m.includes("erfahrung")});if(u.length>0){let c=Math.floor(u.length/2);h=u[c]}else h=t.length>1?t[1]:t[0]}else h=t.length>1?t[1]:t[0];return console.log('Using fallback option: "'.concat(h,'" for question: ').concat(e)),this.conversationHistoryCompany.push({role:"assistant",content:h}),await this.saveConversationHistory(),this.conversationHistory=this.conversationHistory.slice(0,1),this.conversationHistoryCompany=[],h}}catch(o){return console.error("Error details:",{name:o.name,message:o.message,stack:o.stack,cause:o.cause}),t.length>1?t[1]:t[0]}}async answerWithNoOptions(e){var t,o,s,l,r,a,y,p;try{let u=(await this.memory.search(e,3)).map(i=>"".concat(i,": ").concat(this.memory.data[i].text)).join(", ")||"The user has significant experience and qualifications suitable for this question.",c="Form Question: ".concat(e," ?\nUser Context Data Hint: ").concat(u,"\nIMPORTANT:\n- Return ONLY the answer as a plain string\n- If the question requires a number, return ONLY a number\n- If the question requires a phone number, return the user's phone ").concat(((o=(t=this.userData)==null?void 0:t.personal_information)==null?void 0:o.phone)||"","\n- If the question asks for a salary, use the user's expected salary ").concat(((l=(s=this.userData)==null?void 0:s.personal_information)==null?void 0:l.desired_salary)||""," or provide a reasonable estimate based on job market data\n- DO NOT add any explanation or additional text\n- Make sure the answer is professional and benefits the user");this.conversationHistory.push({role:"user",content:c}),this.conversationHistoryCompany.push({role:"user",content:c});let m=this.isExperienceQuestion(e),w=await this.checkOllamaConnection();if(!w.connected){console.error("Ollama not connected:",w.error),console.log("Using fallback mechanism due to connection error");let i;return m?i="5":e.toLowerCase().includes("gehalt")||e.toLowerCase().includes("salary")?i=((a=(r=this.userData)==null?void 0:r.personal_information)==null?void 0:a.desired_salary)||"90000":this.isNumberQuestion(e)?i="3":e.toLowerCase().includes("phone")||e.toLowerCase().includes("telefon")?i=((p=(y=this.userData)==null?void 0:y.personal_information)==null?void 0:p.phone)||"+1234567890":i="Yes",console.log("Using fallback answer: ".concat(i," for question: ").concat(e)),this.conversationHistoryCompany.push({role:"assistant",content:i}),await this.saveConversationHistory(),this.conversationHistory=this.conversationHistory.slice(0,1),this.conversationHistoryCompany=[],i}console.log("Attempting to connect to Ollama server...");try{let i=await this.makeOllamaRequest("chat",{model:this.model,messages:this.conversationHistory,stream:!1,options:{temperature:0}});console.log("Response received successfully");let f=i.message.content.trim().replace(new RegExp("<think>.*?<\\/think>","gs"),"").trim();if(this.isNumberQuestion(e)){let g=f.match(/\d+(?:\.\d+)?/);g&&(m?f=parseFloat(g[0])<1?"1":g[0]:f=g[0])}if(f)return this.conversationHistoryCompany.push({role:"assistant",content:f}),await this.saveConversationHistory(),this.conversationHistory=this.conversationHistory.slice(0,1),this.conversationHistoryCompany=[],f;throw new Error("No valid answer candidate generated")}catch(i){console.error("API error:",i);let d;return m?d="5":e.toLowerCase().includes("gehalt")||e.toLowerCase().includes("salary")?d="90000":this.isNumberQuestion(e)?d="3":d="Yes",console.log("Using fallback answer: ".concat(d," for question: ").concat(e)),this.conversationHistoryCompany.push({role:"assistant",content:d}),await this.saveConversationHistory(),this.conversationHistory=this.conversationHistory.slice(0,1),this.conversationHistoryCompany=[],d}}catch(n){return console.error("Error details:",{name:n.name,message:n.message,stack:n.stack,cause:n.cause}),this.isExperienceQuestion(e)?"5":"Yes"}}isNumberQuestion(e){return["number","how many","zahl","jahre","years","salary","gehalt","euro","eur"].some(o=>e.toLowerCase().includes(o))}isExperienceQuestion(e){let t=e.toLowerCase();return["experience","years","year","erfahrung","jahre","jahr","how long","wie lange","worked with","gearbeitet mit"].some(s=>t.includes(s))}calculateSimilarity(e,t){let o=new Set(e),s=new Set(t);return new Set([...o].filter(r=>s.has(r))).size/Math.max(o.size,s.size)}async answerQuestion(e,t=null){return t&&t.length>0?await this.answerWithOptions(e,t):await this.answerWithNoOptions(e)}},S=v;export{S as default};
